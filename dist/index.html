<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Peludos Lasanimal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      main {
        flex-grow: 1;
      }
      .image-container{
        text-align: center;
      }
      .search-container {
        text-align: center;
        max-width: 90%;
        margin: 0 auto;
        display: block;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 10px;
      }

      .spn-light {
        background-color: mediumturquoise;
        color: black;
        border-color: mediumturquoise;
        padding: .25em .4em;
        font-size: 75%;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: .25rem;
      }
      
      .spn-warn {
        background-color: #ffc107;
        color: black;
        border-color: #ffc107;
        padding: .25em .4em;
        font-size: 75%;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: .25rem;
      }
      
      .btn-apadrina {
        background: black;
        color: white;
        border-color: black;
        margin: 0.25em;
      }
      
      #copyUrlButton{
        float: right;
      }
      
      .btn-acogida {
        background: lightyellow;
        color: black;
        border-color: orange;
        margin: 0.25em;
      }
      .btn-adopcion {
        background: orange;
        color: white;
        border-color: orange;
        margin: 0.25em;
      }
      .btn-difusion {
        background: #f8f9fa;
        color: black;
        border-color: black;
      }
      .btn:hover {
        opacity: 0.8;
      }
      .filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        /*border: 1px solid #ddd;*/
        padding: 10px;
        border-radius: 10px;
        margin-top: 10px;
      }
      .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .filter-chip {
        display: inline-block;
        padding: 8px 15px;
        background: lightyellow;
        border: 1px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
      }
      .filter-chip:hover {
        background: orange;
        color: white;
      }
      .filter-chip.active {
        background: orange;
        color: white;
      }
      .results-count {
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.2rem;
      }
      .results-count i {
        color: orange;
        margin-left: 5px;
      }
      /* Responsiveness */
      @media (max-width: 768px) {
        .search-container {
          max-width: 100%;
        }
        .filter-container {
          flex-direction: column;
          align-items: flex-start;
        }
        .results-count {
          font-size: 1rem;
        }
        /*.filter-group {
          margin-bottom: 10px;
        }
        .filter-chip {
          font-size: 0.9rem;
          padding: 6px 12px;
        }*/
        .filter-group {
          flex-wrap: wrap;
          width: 100%;
        }
        .filter-chip {
          flex: 1 1 calc(50% - 10px); /* Distribuye los filtros en dos columnas */
          text-align: center;
        }
                .filter-chip {
          display: inline-block;
          padding: 8px 15px;
          background: lightyellow;
          border: 1px solid #ddd;
          border-radius: 20px;
          cursor: pointer;
        }
        .filter-chip:hover {
          display: inline-block;
          padding: 8px 15px;
          background: lightyellow;
          border: 1px solid #ddd;
          border-radius: 20px;
          cursor: pointer;
          color: black;
        }
        .filter-chip.active {
          background: orange;
          color: white;
        }
        .filter-chip.active:hover {
          background: orange;
          color: white;
        }
      }

      /* Improve card layout for small devices */
      @media (max-width: 576px) {
        .more-info-btn {
          position: static;
          margin-bottom: 10px;
        }
      }

      .more-info-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: orange;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
      }
      .more-info-btn:hover {
        background: darkorange;
      }
    </style>
  </head>
  <body>
    <header class="bg-dark text-white text-center py-3">
      <h1>¡Encuentra tu peludo!</h1>
    </header>
    <main class="container py-4">
      <div class="search-container">
        <div class="filter-container">
          <div class="filter-group">
            <h6>Nombre:</h6>
            <input id="search-input" type="text" class="form-control">
          </div>
          <div class="filter-group">
            <h6>Sexo:</h6>
            <span class="filter-chip" data-filter="sexo" data-value="macho"><i class="fa-solid fa-mars"></i> Macho</span>
            <span class="filter-chip" data-filter="sexo" data-value="hembra"><i class="fa-solid fa-venus"></i> Hembra</span>
          </div>
          <div class="filter-group">
            <h6>Tamaño:</h6>
            <span class="filter-chip" data-filter="tamaño" data-value="pequeño"><i class="fa-solid fa-s"></i> <15 kg</span>
            <span class="filter-chip" data-filter="tamaño" data-value="mediano"><i class="fa-solid fa-m"></i> 15-30 kg</span>
            <span class="filter-chip" data-filter="tamaño" data-value="grande"><i class="fa-solid fa-l"></i> >30 kg</span>
          </div>
          <div class="filter-group">
            <h6>Edad:</h6>
            <span class="filter-chip" data-filter="edad" data-value="cachorro"><i class="fa-solid fa-baby"></i> <1 año</span>
            <span class="filter-chip" data-filter="edad" data-value="joven"><i class="fa-solid fa-child"></i> [1-3] años</span>
            <span class="filter-chip" data-filter="edad" data-value="adulto"><i class="fa-solid fa-person"></i> [3-7] años</span>
            <span class="filter-chip" data-filter="edad" data-value="senior"><i class="fa-solid fa-person-cane"></i> >7 años</span>
          </div>
          <div class="filter-group">
            <h6>Compatibilidad:</h6>
            <span class="filter-chip" data-filter="compatibilidad" data-value="gatos"><i class="fa-solid fa-cat"></i> Gatos</span>
            <span class="filter-chip" data-filter="compatibilidad" data-value="perros"><i class="fa-solid fa-dog"></i><i class="fa-solid fa-mars"></i> Perros </span>
            <span class="filter-chip" data-filter="compatibilidad" data-value="perras"><i class="fa-solid fa-dog"></i><i class="fa-solid fa-venus"></i> Perras </span>
          </div>
          <div class="filter-group">
            <h6>Vulnerabilidad:</h6>
            <span class="filter-chip" data-filter="vulnerabilidad" data-value="enfermo"><i class="fa-solid fa-house-medical"></i> Enfermo</span>
            <span class="filter-chip" data-filter="vulnerabilidad" data-value="veterano"><i class="fa-solid fa-star"></i> Veterano</span>
            <span class="filter-chip" data-filter="vulnerabilidad" data-value="PPP"><i class="fa-solid fa-square-check"></i> PPP</span>
          </div>
        </div>
        <a role="button" class="btn btn-large btn-secondary" href="/" title="Deshacer">Reset</a>
        <button id="btn-search" class="btn btn-large btn-dark" type="button" title="Buscar">Buscar</button>
        <button id="copyUrlButton" class="btn btn-outline-secondary" title="Compartir selección"><i class="fa-solid fa-link"></i></button>
      </div>

      <!-- Resultado de búsqueda -->
      <div class="results-count">
        <p><strong>0</strong> peludos encontrados</p>
      </div>

      <!-- Fila de tarjetas -->
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4 mt-4">
      </div>
    </main>

    <footer class="bg-dark text-white text-center py-3">
      <p>Peludos Lasanimal - Todos los derechos reservados &copy; 2025</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Function to update the URL with active filter parameters & search input
      function updateURL() {
        const params = new URLSearchParams();

        // Collect active filter chips
        document.querySelectorAll('.filter-chip.active').forEach((chip) => {
          const filter = chip.getAttribute('data-filter');
          const value = chip.getAttribute('data-value');
          params.append(filter, value); // Append multiple values for the same key
        });

        // Collect search input value
        const searchInput = document.getElementById('search-input');
        if (searchInput.value.trim() !== '') {
          params.set('nombre', searchInput.value.trim()); // Add keyword if not empty
        }

        // Update the URL
        window.history.replaceState({}, '', '?' + params.toString());
      }

      // Function to initialize filters & search input based on the URL parameters
      function initializeFiltersFromURL() {
        const params = new URLSearchParams(window.location.search);

        // Activate filter chips from URL
        params.forEach((value, key) => {
          document.querySelectorAll(`.filter-chip[data-filter="${key}"][data-value="${value}"]`).forEach((chip) => {
            chip.classList.add('active');
          });
        });

        // Fill the search input if 'keyword' exists in URL
        const searchInput = document.getElementById('search-input');
        if (params.has('nombre')) {
          searchInput.value = params.get('nombre');
        }
      }

      // Event listener for filter button clicks
      document.querySelectorAll('.filter-chip').forEach((button) => {
        button.addEventListener('click', function () {
          this.classList.toggle('active');
          updateURL();
        });
      });

      // Event listener for search input changes
      const searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', updateURL);

      // Event listener for search input changes
      document.getElementById('copyUrlButton').addEventListener('click', function() {
          // Get the current page URL
          const url = decodeURIComponent(window.location.href);
          // Copy the URL to the clipboard
          navigator.clipboard.writeText(url).then(function() {
              alert('URL copied to clipboard: ' + url);
          }).catch(function(error) {
              console.error('Failed to copy URL: ', error);
          });
      });
      // Initialize filters and search input on page load
      initializeFiltersFromURL();
    </script>
    <script type="text/javascript">
      function capitalizeName(name) {
          return name.replace(/\b\w/g, (char) => char.toUpperCase());
      }
      function createBadges(items) {
          return items.map(item => `<span class="spn-light">${item}</span>`).join(' ');
      }
      function decodeHtmlEntities(encodedStr) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(encodedStr, "text/html");
          return doc.body.innerHTML;
      }
      // Function to display cards
      async function displayDogs(dogs) {
          const container = document.querySelector('.row.row-cols-1');
          container.innerHTML = ''; // Clear previous content                
          dogs.forEach(dog => {
             // Decode `dog.fotografia` before inserting it
            let imgContent = dog.fotografia 
                ? decodeHtmlEntities(dog.fotografia)  
                : `<a data-flickr-embed="true" href="https://www.flickr.com/photos/202291935@N05/54351007578/in/datetaken/lightbox/" title="default">
                      <img src="https://live.staticflickr.com/65535/54351007578_9e25b9ab8d_w.jpg" width="400" height="400" alt="default"/>
                   </a>`;
            
              let badges = createBadges(dog.raza.split(','));
              const card = document.createElement('div');
              card.classList.add('col');
              card.innerHTML = `
                  <div class="card">
                      <a role="button" class="btn btn-sm more-info-btn" href="detail/?nombre=${capitalizeName(dog.nombre)}">Más info</a>
                      <div class="image-container">
                        ${ imgContent }
                      </div>
                      <div class="card-body">
                          <h5 class="card-title">${capitalizeName(dog.nombre)} <i class="fa-solid fa-paw"></i></h5>
                          <span><i class="fa-solid fa-shield-dog"></i> ${ badges }</span>
                          ${dog.ppp === 'Si' ? '<span class="spn-warn"><i class="fa-solid fa-square-check"></i> PPP </span>' : '' }
                          <p class="card-text">${dog.historiabreve || 'Se desconoce historia'}</p>
                      </div>
                      <div class="card-footer">
                          ${ dog.fase.includes('Residencia') ? '<a role="button" href="/formulario-apadrina" class="btn btn-sm btn-apadrina"><i class="fa-solid fa-heart"></i> Apadrina</a><a role="button" href="/formulario-acoge" class="btn btn-sm btn-acogida"><i class="fa-solid fa-house"></i> Acoge</a><a role="button" href="/formulario-adopta" class="btn btn-sm btn-adopcion"><i class="fa-solid fa-house-flag"></i> Adopta</a>' : ''}
                          ${ dog.fase === 'Acogida' ? '<a role="button" href="/formulario-apadrina" class="btn btn-sm btn-apadrina"><i class="fa-solid fa-heart"></i> Apadrina</a><a role="button" href="/formulario-adopta" class="btn btn-sm btn-adopcion"><i class="fa-solid fa-house-flag"></i> Adopta</a>' : ''}
                          ${ dog.fase === 'Calle' ? '<a role="button" href="/formulario-apadrina" class="btn btn-sm btn-apadrina"><i class="fa-solid fa-heart"></i> Apadrina</a><a role="button" href="/formulario-acoge" class="btn btn-sm btn-acogida"><i class="fa-solid fa-house"></i> Acoge</a><a role="button" href="/formulario-adopta" class="btn btn-sm btn-adopcion"><i class="fa-solid fa-house-flag"></i> Adopta</a>' : ''}
                      </div>
                  </div>
              `;
              container.appendChild(card);
          });
          document.querySelector('.results-count p strong').textContent = dogs.length;
       }      
      // Function to parse query parameters and handle multiple values
      const parseQueryParam = param => {
          if (!param) return null;
          return Array.isArray(param) ? param.map(p => p.toLowerCase()) : [param.toLowerCase()];
      };
      
      // Function to get data (from LocalStorage or API)
      async function getPeludosData() {
        // Get query parameters from the current URL
        const urlParams = new URLSearchParams(window.location.search);
      
        // Extract parameters (handling multiple values where applicable)
        const nombre = urlParams.get('nombre');
        
        const sexo = urlParams.getAll('sexo'); // Gets all values as an array
        const sexArray = sexo.length ? parseQueryParam(sexo) : null;
        
        const tamaño = urlParams.getAll('tamaño');
        const sizeArray = tamaño.length ? parseQueryParam(tamaño) : null;
        
        const edad = urlParams.getAll('edad');
        const ageArray = edad.length ? parseQueryParam(edad) : null;
        
        const vulnerabilidad = urlParams.getAll('vulnerabilidad');
        const vulnerabilidadArray = vulnerabilidad.length ? parseQueryParam(vulnerabilidad) : null;
        
        const compatibilidad = urlParams.getAll('compatibilidad');
        const compatibilidadArray = compatibilidad.length ? parseQueryParam(compatibilidad) : null;
      
        // Fetch the data
        let dataURL="https://sheetlabs.com/LASA/peludos/?publicar=Si"
        // Filter by Name if provided (case-insensitive)
        if (nombre) {
          dataURL = dataURL+'&nombre='+nombre
        }
        // Filter by Compatibility if provided (case-insensitive)    
        if (compatibilidadArray) {
          const okCats = compatibilidadArray.includes("gatos")
          if (okCats){
            dataURL = dataURL+'&sociabilidadgatos=Si'
          }
          const okMales = compatibilidadArray.includes("perros")
          if (okMales){
            dataURL = dataURL+'&sociabilidadperros=Si'
          }
          const okFemales = compatibilidadArray.includes("perras")
          if (okFemales){
            dataURL = dataURL+'&sociabilidadperras=Si'
          }  
        }    
        if (vulnerabilidadArray) {
          const isPPP = vulnerabilidadArray.includes("ppp")
          if (isPPP){
            dataURL = dataURL+'&ppp=Si'
          }
          const isVet = vulnerabilidadArray.includes("veterano")
          if (isVet){
            dataURL = dataURL+'&veterano=Si'
          }
          const isSick = vulnerabilidadArray.includes("enfermo")
          if (isSick){
            dataURL = dataURL+'&condicion=Enfermo'
          }  
        }
        console.log("🌍 Fetching new data from API...");
        try {
          const response = await fetch(dataURL);
          if (!response.ok) throw new Error("Failed to fetch data");
          const data = await response.json();
          // Filter by Sex if provided
          if (sexArray) {
            data = data.filter(item => item.sexo && sexArray.includes(item.sexo.toLowerCase()));
          }
          // Filter by Size if provided
          if (sizeArray) {
            data = data.filter(item => item.talla && sizeArray.includes(item.talla.toLowerCase()));
          }
          // Filter by Size if provided
          if (ageArray) {
            data = data.filter(item => item.tramoedad && ageArray.includes(item.tramoedad.toLowerCase()));
          }
          return data;
        } catch (error) {
          console.error("❌ Error fetching data:", error);
          return null;
        }
      }
      // LANDING
      getPeludosData().then((data) => {
        if (data) {
              try {
                displayDogs(data);
            } catch (error) {
                console.error('Error fetching dogs:', error);
            }
        }
      });
      //ADD EVENT LISTENERS
      document.getElementById('btn-search').addEventListener('click', function () {
        getPeludosData().then((data) => {
        if (data) {
                try {
                  displayDogs(data);
              } catch (error) {
                  console.error('Error fetching dogs:', error);
              }
          }
        });
      });
    </script>
  </body>
</html>
